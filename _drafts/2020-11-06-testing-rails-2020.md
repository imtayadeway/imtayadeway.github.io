---
layout: post
title: Testing Rails in 2020
tags:
- testing
- ruby
date: 2020-11-06 19:11:17
---

Like countless others, I learned Ruby on Rails (and a great deal more) from Michael Hartl's [Ruby on Rails Tutorial][]. Though I haven't kept up with all the changes in the most recent revisions, I know that back in 2012 things were a bit different. In particular, I learned that it was the done thing to eschew the testing framework that came with Rails in favor of RSpec, and to toss aside the fixtures library in favor of something called Factory Girl (since renamed Factory Bot). Now I believe Hartl has abandoned much of that in preference to using only the things that come with Rails by default. I'm not that surprised - I recall this being a lot to learn all at once, and it felt awkward to be fighting from the first steps the framework I was trying to learn, whose very ethos is the following of conventions, before I could even grasp the nuances of why I might be doing this.

As influential as Hartl's tutorial may have been, this change in the tide it seems has failed to make much of a splash in the Ruby community at large. I've only ever once collaborated on a Rails project that followed all of the conventions. Almost every project I've worked on professionally has been of the Rails/RSpec/Factory Bot variety. In this post I want to expose some of the assumptions underpinning these choices, and to question if these assumptions are still valid. I'll also suggest that the Rails defaults are not merely a better choice for beginners, but may be better all round.

I don't want to dwell too much on the relative merits of RSpec. I think it is a fine testing framework, I've contributed to it, and I especially love its extensive expectations library, which I've also [written about before][]. I also love Minitest. Though I've used it less, I am now using Minitest for all my new personal projects. I won't say that one is better than the other. Maintainer Sam Phippen describes RSpec as a tool that "excels at testing legacy code"[^1] and this bears out at least in my experience - I'd probably prefer to use RSpec to retrofit a test suite to a legacy code base, but prefer to use Minitest for greenfield development.

Factory Bot, on the other hand, I think invites some scrutiny. thoughtbot [sold Factory Bot][] entirely on the basis of addressing the [Mystery Guest][] problem, a kind of Obscure Test, a well-known XUnit Test Antipattern. It trades on allowing you to write clearer tests at the expense of having to create and rollback every test fixture you need every time, starting every test with a pristine, blank database. This can be a major cause of test slowness, and it would be pertinent to point out that test slowness has been a common complaint for as long as I have been using Rails. You would think then that the Mystery Guest problem had better be a significant one for this to be a good trade off.

For anyone unfamiliar, the Mystery Guest problem stated as follows:

> The test reader is not able to see the cause and effect between fixture and verification logic because part of it is done outside the Test Method. [^2]

In a vanilla Rails application, this problem is exemplified in the use of Rails' persistent fixtures:

```ruby
RSpec.describe User do
  it "has a full name" do
    expect(users(:alice).full_name).to eq("Alice Anderson")
  end
end
```

To the test reader, it's not clear where the user's full name comes from, or from what data it is derived. To contrast, with Factory Bot:

```ruby
RSpec.describe User do
  it "has a full name" do
    user = create(:user, first: "Alice", last: "Anderson")

    expect(user.fullname).to eq("Alice Anderson")
  end
end
```

In this example it is immediately clear to the reader the relationship between the data that was passed to the fixture and the derived outcome of the full name text.

The Mystery Guest is an XUnit antipattern, and the use of factories allows us to follow XUnit patterns, namely the [Four-Phase Test][]. The idea behind this pattern is that every test should tell a story:

```ruby
RSpec.describe User do
  it "can change address" do
    # setup
    user = create(:user, address: "742 Evergreen Terrace", city: "Springfield")

    # exercise
    user.address = "123 Fake Street"

    # verify
    expect(user.full_address).to eq("123 Fake St, Springfield")

    # teardown
    # usually the test framework will take care of tearing down any fixtures for you, so nothing to do here
  end
end
```

It is only natural then that thoughtbot feel strongly that you should also [follow XUnit test patterns][] when you write your specs. The big problem here is that RSpec is not an XUnit style testing framework, and it is my observation that most people do not follow XUnit best practices, preferring to write highly idiomatic RSpec code instead:

```ruby
RSpec.describe User do
  let(:address) { "742 Evergreen Terrace" }
  let(:city) { "Springfield" }
  let(:user) { create(:user, address: address, city: city) }

  # 100s of lines of test code

  describe "#full_address" do
    it "it has a full address" do
      expect(user.full_address).to eq("742 Evergreen Terrace, Springfield")
    end
  end
end
```

Or, alternatively:

```ruby
RSpec.describe User
  let(:address) { "742 Evergreen Terrace" }
  let(:city) { "Springfield" }
  subject(:user) { create(:user, address: address, city: city) }

  # 100s of lines of test code

  describe "#full_address" do
    its(:full_address) { should eq("742 Evergreen Terrace, Springfield") }
  end
end
```

As you can see, we have now thwarted our attempt at addressing the Mystery Guest problem simply by writing idiomatic RSpec code. RSpec is not an XUnit test framework and it is not its goal to facilitate use of all the XUnit test patterns.

If the authors of Factory Bot recommend that we were discard parts of the RSpec DSL in the pursuit of more readable, XUnit-style tests, it is surprising that they did not recommend foremost that we use, you know, an actual XUnit test framework, such as Minitest:

```ruby
class TestUser < Minitest::Test
  def test_change_address
    # setup
    user = create(:user, address: "742 Evergreen Terrace", city: "Springfield")

    # exercise
    user.address = "123 Fake Street"

    # verification
    assert_equal("123 Fake Street, Springfield", user.full_address)

    # teardown
    # nothing to do here
  end
end
```

It is perhaps also surprising that some of the features of Factory Bot seem to undercut its original aim by helping us to write Obscure Tests. Using traits, for example:

```ruby
# spec/factories.rb
FactoryBot.factory(:user) do
  first { "Alice" }
  last { "Anderson" }

  trait :adult do
    date_of_birth { 21.years.ago }
  end
end

# spec/models/user_spec.rb
RSpec.describe do
  example "adulthood" do
    user = create(:user, :adult)
    expect(user).to be_adult
  end
end
```

Sure, I can see the fixture getting created there in the test body, but now it's unclear to me what conditions were necessary to arrive at that outcome. Compare this to Rails fixtures:

```yaml
# spec/fixtures/users.yml

alice:
  first: Alice
  last: Anderson
  date_of_birth: <%= 21.years.ago %>
```

```ruby
# spec/models/user_spec.rb

RSpec.describe User do
  describe "adulthood" do
    specify "over 21" do
      expect(users(:alice)).to be_adult
    end
  end
end
```

With the Factory Bot example, we have to internalize what data makes up the traits we've defined. With Rails' fixtures we have to internalize the story of Alice as a person, and all the characteristics she embodies. But it is essentially the same problem.

If then we find our test suites rife with Obscure Tests and we are using Factory Bot, then we have gained nothing and only made our tests slower with all the extra overhead.

I recommend then that if you want to use Factory Bot, only to use its most basic features and to use it with an XUnit-style framework such as Minitest. It is much harder in my view to enforce the Four-Phase Test style of writing tests in your organization when this goes against the grain of the RSpec DSL.

Further, if you are not tied to using Factory Bot, or just wish you had faster tests, consider using Rails' fixtures instead. If you are already writing idiomatic RSpec there is a good chance that you won't feel any new Mystery Guest pain just by doing this. And your test suite will be faster.

But honestly, why not Minitest *and* Rails' fixtures? For greenfield development, this is precisely the setup that Rails provides you with right from the moment you type `rails new`. It's the one that Michael Hartl teaches in his tutorial. It'll make both learning Rails and onboarding people onto your project more accessible by reducing the number of things they have to learn just to get started. And it's much simpler to be able to say that you follow all of the Rails conventions as you point to its documentation, than to have to explain all the individual choices you made when departing from the defaults. You'll have faster tests, with less setup, because you won't have to recreate the world for every integration test that you execute.

My experience right from starting with the Ruby on Rails Tutorial, through everything I've worked on professionally, has been that every project has had some variation of this complicated setup I learned back in 2012. If this is your experience too, I invite you to experiment in your next Rails project with the default test framework. Keep an open mind, play around with it, notice the differences, allow yourself to feel any of the pain points that come up, and perhaps any pleasant surprises, for yourself before evaluating. If you find yourself still preferring your bespoke setup, you may walk away with a richer understanding of the problems those tools were trying to address, and maybe you'll write better tests for it. Or, like me, you may decide that whatever wisdom we had back in 2012 (or whenever it is that this all started) doesn't suit us as well in 2020, and it's time for a change.

[^1]: Interview with Sam Phippen: https://www.infoq.com/articles/Effective-Ruby-Livelessons-Interview-Sam-Phippen/
[^2]: http://xunitpatterns.com/Obscure%20Test.html#Mystery%20Guest

[follow XUnit test patterns]: https://thoughtbot.com/blog/lets-not
[Four-Phase Test]: http://xunitpatterns.com/Four%20Phase%20Test.html
[Mystery Guest]: http://xunitpatterns.com/Obscure%20Test.html#Mystery%20Guest
[Ruby on Rails Tutorial]: https://www.railstutorial.org/
[sold Factory Bot]: https://thoughtbot.com/blog/waiting-for-a-factory-girl
[written about before]: http://timjwade.com/2017/02/20/factories-arent-fixtures.html
